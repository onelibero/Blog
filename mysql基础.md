# 一、基本概念

数据库（DataBase）：存储数据的仓库，数据是有组织的进行存储

数据库管理系统（DataBase Management System）：操作和管理数据的大型软件

SQL：操作关系型数据库的编程语言，定义了一套操作关系型数据库的统一标准

下载自行搜索

## 客户端连接

1. MySQL提供的客户端工具（MySQL 8.0 Command Line Client - Unicode）
2. 系统自带的命令行工具（cmd执行命令 mysql [-h 127.0.0.1] [-p 3306] -u root -p）

# 二、数据类型

### （1）整数类型

| 数据类型  | 字节数 | 无符合数取值范围       | 有符号数取值范围                         |
| --------- | ------ | ---------------------- | ---------------------------------------- |
| TINYINT   | 1      | 0~255                  | -128~127                                 |
| SMALLINT  | 2      | 0~65535                | -32768~32768                             |
| MEDIUMINT | 3      | 0~16777215             | -8388608~8388608                         |
| INT       | 4      | 0~4294967295           | -2147483648~2147483648                   |
| BIGINT    | 8      | 0~18446744073709551615 | -9223372036854775808~9223372063854775808 |

类型说明使用：age TINYINT （更小的字节数）

unsigned 表示为非负，建表时加在数据类型后即可 `age TINYINT unsigned`

### （2）浮点数类型

| 数据类型 | 字节数 | 有符号取值范围                                | 无符号取值范围                                  |
| -------- | ------ | --------------------------------------------- | ----------------------------------------------- |
| FLOAT    | 4      | -3.402823466 E+38~1.175494351 E-38            | 0 和 （1.175494351 E-38，3.402823466 E+38）     |
| DOUBLE   | 8      | -1.7976931348623157 E+308~1.79******157 E+308 | 0 和 （2.2250738585072014 E-380~ 1.79*57E+308） |
| DECIMAL  | M+2    | 依赖于M（精度）和D（标度）的值                | 依赖于M（精度）和D（标度）的值                  |

### （3）字符串类型

| 数据类型 | 存储需求                                                     |
| -------- | ------------------------------------------------------------ |
| char     | char对应大小的字节，如char(3)占用三个字节无论char多长，char超出则只会存储三个字节的内容 |
| varchar  | 如果存储内容比给的存储空间小，则是存储内容+1的字节数，反之则是存储给的空间的大小的内容 |

> char性能比varchar性能高

使用：性别 char(1)

用户名 varchar(50)

### （4）文本类型

| 数据类型   | 存储范围         |
| ---------- | ---------------- |
| TINYTEXT   | 0~255字节        |
| TEXT       | 0~65535字节      |
| MEDIUMTEXT | 0~16777215字节   |
| LONGTEXT   | 0~4294967295字节 |

### （5）日期类型

| 数据类型  | 字节数 | 取值范围                                    | 日期格式            |
| --------- | ------ | ------------------------------------------- | ------------------- |
| YEAR      | 1      | 1901~2155                                   | YYYY                |
| DATE      | 4      | 100-01-01~9999-12-31                        | YYYY-MM-DD          |
| TIME      | 3      | -835:59:59 ~ 835:59:59                      | HH:MM:DD            |
| DATETIME  | 8      | 1000-01-01 00:00:00:00 ~9999-12-31 23:59:59 | YYYY-MM-DD HH:MM:SS |
| TIMESTAMP | 4      | 1970-01-01 00:00:01 ~ 2098-01-19 03:14:07   | YYYY-MM-DD HH:MM:SS |

使用：birthday DATE

# 三、关系型数据库

建立在关系模型基础上，由多张项目连接的二维表组成的数据库

特点：

- 使用表存储数据，格式统一便于维护
- 使用SQL语言操作，标准统一便于维护

数据模型

通过客户端操作DBMS（数据库管理系统）操作数据库进行表操作

# 四、SQL

## （1）通用语法

- SQL语句可以单行或多行书写，以分号结尾
- SQL语句可以使用空格/缩进来增强语句的可读性
- MySQL数据库的SQL语句不区分大小写，关键字建议使用大写
- 注释：
  - 单行注释：--注释内容或#注释内容（MySQL特有）
  - 多行注释：/*注释内容*/

## （2）分类

- DDL：数据定义语言，用来定义数据库对象（数据库，表，字段）
- DML：数据操作语言，用来对数据库表中的数据进行增删改
- DQL：数据查询语言，用来查询语言，用来查询数据库中表的记录
- DCL：数据控制语言，用来创建数据库用户、控制数据库的访问权限

### DDL-数据库操作

```sql
//查询所有数据库
show databases;
//查询当前数据库
select database();
//创建
create database [if not exists] 数据库名 [default charset 字符集][collate 排序规则];
//删除
drop database [if not exists] 数据库名;
//使用
use 数据库名;
//查询当前数据库的所有表
show tables;
//查询表结构
desc 表名;
//查询指定表的建表语句
show create table 表名;
//创建表
create table 表名(
    字段1 类型 [comment 注释信息],
    字段2 类型 [comment 注释信息],
    * * * * * * * * * * * * * *
    字段n 类型 [comment 注释信息]
)[comment 表注释信息];
//添加字段
alter table 表名 add 字段名 类型(长度) [comment 注释][约束];
//修改字段数据类型
alter table 表名 modify 字段名 新数据类型(长度);
//修改字段名和字段类型
alter table 表名 change 旧字段名 新字段名 类型[长度][comment 注释][约束];
//删除字段
alter table 表名 drop 字段名;
//修改表名
alter table 表名 rename to 新表名;
//删除表
drop table [if not exists] 表名;
//删除指定表并重新创建该表
truncate table 表名;
```

### DML-数据操作

- 添加数据（INSERT）

```sql
//给指定字段添加数据
insert into 表名(字段名1，字段名2，...) values (值1，值2，...);
//给全部字段添加数据
insert into 表名 values (值1，值2，...);
//批量添加数据
insert into 表名(字段名1，字段名2，...) values (值1，值2，...),(值1，值2，...);
insert into 表名 values (值1，值2，...),(值1，值2，...);
```

- 修改数据（UPDATE）

```sql
update 表名 set 字段名1 = 值1，字段名2= 值2 ，...[where 条件];
```

- 删除数据（DELETE）

```sql
delete from 表名 [where 条件];
```

### DQL-数据查询

> 查询关键字：select

```sql
//编写顺序
select 字段列表 from 表名列表 where 条件列表 group by 分组字段列表 having 分组后条件列表 order by 排序字段列表 limit 分页参数;
//查询顺序
表名 条件 分组（字段，条件） 字段 排序 分页 
```

- 基本查询

```sql
//查询多个字段
select 字段1，字段2，... from 表名;
select * from 表名;
//设置别名
select 字段1 [as 别名1],字段2[as 别名2] ... from 表名;           //as可以省略
//去除重复记录
select distinct 字段列表 from 表名;
```

- 条件查询（where）

  | 逻辑运算符 | 功能                         |
  | ---------- | ---------------------------- |
  | AND 或 &&  | 并且（多个条件同时成立）     |
  | OR 或 \|\| | 或者（多个条件任意一个成立） |
  | NOT或！    | 非，不是                     |

  | 比较运算符(>, >= , < , <=, = ) | 功能                                       |
  | ------------------------------ | ------------------------------------------ |
  | <>或！=                        | 不等于                                     |
  | between...and...               | 在某个范围                                 |
  | in（...）                      | 在in之后的列表中的值，多选一               |
  | like 占位符                    | 模糊匹配（_匹配某个字符，%匹配任意个字符） |
  | is null                        | 是null                                     |

```sql
select 字段列表 from 表名 where 条件列表;
```

- 聚合函数（count 统计数量，max 最大值，min 最小值，avg 平均值，sum 求和）

```sql
select 聚合函数（字段列表） from 表名;
```

- 分组查询（group by）

> where和having区别
>
> 1.执行时机不同：where对分组前进行过滤，having对分组后结果进行过滤
>
> 2.判断条件不同：where不能对聚合函数进行判断，而having可以

分组之后查询的字段一般为聚合函数和分组字段，查询其他字段无意义

```sql
select 字段列表 from 表名 [where 条件] group by 分组字段名 [having 分组后过滤条件];
```

- 排序查询（order by）
  - ASC：升序（默认）
  - DESC：降序

```sql
select 字段列表 from 表名 order by 字段1 排序方式1, 字段2 排序方式2;
```

- 分页查询（limit）
  - 起始索引：从0开始，起始索引=（查询页码-1）*每页显示记录数
  - 分页查询是数据库方言，mysql是limit
  - 如果查询的是第一页数据，起始索引可以省略

```sql
select 字段列表 from 表名 limit 起始索引，查询记录数;
```

### DCL-权限管理

用来管理数据库用户、控制数据库的访问权限

#### 管理用户

```sql
//查询用户
user mysql;
select *from  user;
//创建用户
create user '用户名'@'主机名' identified by '密码'; //只能在本地访问 将主机名改成 %则可以任意主机访问
//修改用户密码
alter user '用户名'@'主机名' identified with mysql_native_password by '新密码';
//删除用户
drop user '用户名'@'主机名';
```

#### 权限控制

1. all，all privileges：所有权限
2. select，insert，update，delete：数据的增删查改
3. alter：修改表
4. drop：删除数据库/表/视图
5. create：创建数据库/表

> 授权时表和库可以用*表示所有

```sql
//查看权限
show grants for '用户名'@'主机名';
//赋予权限
grant 权限列表 on 数据库名.表名 to '用户名'@'主机名';
//撤销权限
revoke 权限列表 on 数据库名.表名 from '用户名'@'主机名';
```

# 五、函数

> 函数：指一段可以直接被另一段程序调用的程序或代码

###  字符串函数

| 函数                         | 功能                                            |
| ---------------------------- | ----------------------------------------------- |
| concat（s1,s2,s3）           | 字符串拼接                                      |
| lower（str）                 | 全部转为小写                                    |
| upper（str）                 | 全部转为大写                                    |
| lpad（str，n，pad）          | 左填充，字符串pad对str左边进行填充直到长度到达n |
| rpad（str，n，pad）          | 右填充，字符串pad对str右边进行填充直到长度到达n |
| trim（str）                  | 去掉字符串头部和尾部的空格                      |
| sumstring（str，start，len） | 返回从字符串str从start起的len个长度的字符串     |

sql书写：`select 函数(参数)`

### 数值函数

| 函数         | 功能                               |
| ------------ | ---------------------------------- |
| ceil（x）    | 向上取整                           |
| floor（x）   | 向下取整                           |
| mod（x,y）   | 返回x/y的模                        |
| rand（）     | 返回0~1内的随机数                  |
| round（x,y） | 求参数x的四舍五入的值，保留y位小数 |

> 案例：生成一个六位数的随机数
>
> select lpad(round(rand()*1000000,0),5,0);

### 日期函数

| 函数                                 | 功能                                                    |
| ------------------------------------ | ------------------------------------------------------- |
| curdate（）                          | 返回当前日期                                            |
| curtime（）                          | 返回当前时间                                            |
| now（）                              | 返回当前日期和时间                                      |
| year（date）                         | 获取指定的date的年份                                    |
| month（date）                        | 获取指定的date的月份                                    |
| day（date）                          | 获取指定date的日期                                      |
| date_add（date，interval expr type） | 返回一个日期/时间值上加上一个时间间隔expr后的时间值     |
| datediff（data1，data2）             | 返回起始时间date1和结束时间date2之间的天数(date1-date2) |

> select date_add(now(),interval 70 year)

### 流程函数

| 函数                                                      | 功能                                                     |
| --------------------------------------------------------- | -------------------------------------------------------- |
| if（value，t，f）                                         | 如果value为true则返回t，否则返回f                        |
| ifnull（value1，value2）                                  | 如果value1不为空，返回value1，否则返回value2             |
| case when（val1）then [res1]... else [default] end        | 如果val1位true，返回res1，...否则返回default默认值       |
| case[expr] when [val1] then [res1] ... else [default] end | 如果expr的值等于vall，返回res1，...否则返回default默认值 |

# 六、约束

> 概念：作用域表中字段上的规则，用于限制存储在表中的数据（作用于字段，在建表或修改表时创建）
>
> 目的：保证数据库中数据的正确、有效性和完整性

| 约束     | 描述                                                     | 关键字      |
| -------- | -------------------------------------------------------- | ----------- |
| 非空约束 | 限制该字段的数据不能为null                               | not null    |
| 唯一约束 | 保证该字段的所有数据都是唯一、不重复的                   | unique      |
| 主键约束 | 主键是一行数据的唯一标识，要求非空且唯一                 | primary key |
| 默认约束 | 保存数据时，如果未指定该字段的值，则采用默认值           | default     |
| 检查约束 | 保证字段值满足某一个条件                                 | check       |
| 外键约束 | 用来让两张表的数据之间建立连接，包子数据的一致性和完整性 | foreign key |



```sql
create table user(
  id int primary key auto_increment comment '主键',
  name varchar(10) not null unique comment '姓名',
  age int check (age>0 && age<= 120) comment '年龄',
  status char(1) default '1' comment '状态',
  gender char(1) comment '性别'
)comment '用户表';
```

### 外键约束

> 外键约束：外键是用来让两张表的数据之间建立连接，从而保证数据的一致性和完整性，不然两张表只是单纯的逻辑关系，当一方删除那条数据，与之有逻辑关系的那一方不会发生改变

```sql
create table 表名(
  字段名 数据类型，
  ...
  [constraint] [外键名称] foreign key (外键字段名) references 主表(主表列名)
);

alter table 表名 add [constraint] [外键名称] foreign key (外键字段名) references 主表(主表列名);

//删除外键
drop table 表名 drop foreign key [外键名称];
```

删除/更新行为

| 行为        | 说明                                                         |
| ----------- | ------------------------------------------------------------ |
| no action   | 当在父表中删除/更新对应记录时，首先检查该记录是否有对应外键，如果有则不允许删除/更新 |
| restrict    | 当在父表中删除/更新对应记录时，首先检查该记录是否有对应的外键，如果有则不允许删除/更新 |
| cascade     | 当在父表中删除/更新对应记录时，首先检查该记录是否有对应外键，如果有，则也删除/更新外键在字表中的记录 |
| set null    | 当在父表中删除/更新对应记录时，首先检查该记录是否有对应外键，如果有则是这字表中该外键值为null |
| set default | 父表有变更时，字表将外键列设置成一个默认的值                 |



```
alter table 表名 add constraint 外键名称 foreign key 外键字段 references 主表名(主键字段名) on update [更新行为] on delete [删除行为]
```

# 七、多表查询

> 在进行数据库结构设计时，会根据业务需求及业务模块之间的联系分析设计表结构，业务直接相互关联所以表结构之间也应该相互关联，主要包括：一对一，一对多，多对多

## 多表关系

- 一对多：如一个部门对应多个员工，一个员工对应一个部门 （实现：在多的一方建立外键指向一的那一方的主键）
- 多对多：如学生对应多个课程，一个课程对应多个学生（实现：建立中间表，中间表包含两个外键分别关联两方主键）
- 一对一：如用户和用户详情（一对一关系多用于单表拆分，将一张表的基本字段放在一张表中，其他详情放在另一张表中，以提升操作效率）（实现：在任意一方加入外键关联另一方的主键，并且设置外键为唯一的）

## 多表查询

> 从多张表中查询数据
>
> 笛卡尔积：笛卡尔积是指在数学中两个集合所有的组合情况（多表查询中要消除无效的笛卡尔积）

### 1.连接查询

#### （1）内连接（查询两张表交集部分）

- 隐式内连接：`select 字段列表 from 表1，表2 where 条件 ... ;`
- 显式内连接：`select 字段列表 from 表1 [inner] join 表2 on 连接条件 ...;`

#### （2）外连接

- 左外连接：`select 字段列表 from 表1 left [outer] join 表2 on 条件 ...;`（查询左表全部数据包含和右表交集数据）
- 右外连接：`select 字段列表 from 表1 right [outer] join 表2 on 条件 ...;`（查询右表全部数据包含和左表交集数据）

#### （3）自连接

`select 字段列表 from 表1 别名1 join 表1 别名2 on 条件 ...; `（自连接查询key是内连接查询，也可以是外连接查询）

> 案例：员工表的直属领导（存的是id），查询员工和其所属领导时

### 2.联合查询-union，unionall

```
select 字段列表 from 表1 ... union [all] select 字段列表 from 表2 ...;
```

unionall是吧两个查询结果直接合并 union是吧两个查询结果合并后去重（列数和字段类型必须保持一致）

### 3.子查询

> sql语句中嵌套select语句，称为嵌套查询，又称子查询

```
select 字段名 from 表名 where 字段名 = (select 字段名 from 表名);
```

子查询外部的语句可以是insert/update/delete/select中的任何一个

#### （1）标量子查询（子查询结果为单个值）

```
如：根据部门id查询其部门员工信息，查询在某员工入职之后的其他员工的信息
常用操作符：= <> <= >= > <
```

#### （2）列子查询（子查询结果为一列）

```
如：查询两个部门的所有员工信息，查询比某部门所有人工资都高的员工信息
常用操作符：in，not in，any，some，all(放于嵌套语句前)
如 select * from 表名 where salary > all(查询的部门的工资)
```

#### （3）行子查询（子查询结果为一行）

```
如：查询某个员工的薪资及其直属领导相同的员工信息
如：select * from 表名 where (salary,managerid) = (薪资,领导id)
```

#### （4）表子查询（查询结果为多行多列）

```
如：查询与两个员工的职位和薪资相同的员工信息
如：select * from 表名 where (job,salary) in (查询出来的薪资和职位)
```

针对多表查询的设计：

1. 确定要查询的表
2. 确定连接条件
3. 确定查询条件

```
如：查询低于本部门平均薪资的员工信息：select * from 表名 别名1 where 别名1.salary < (select avg(别名2.salary) from 表名 别名2 where 别名1.部门id=别名2.部门id)
查询所有部门信息并统计人数：select d.*,(select count(*) from 表名 e where e.部门id = d.id) '人数' from 部门表名 d
```

# 八、事务

事务是一组操作的集合，它是一个不可分割的工作单位，事务会把所有的操作作为一个整体一起向系统提交或撤销操作请求，即这些操作要么同时成功，要么同时失败

### 事务操作

- 查看/设置事务提交方式

  `select @@autocommit; (1为自动提交，0为手动提交)`

  `set @@autocommit = 0;`

  `start transaction 或 begin 开启事务`

- 提交事务

  `commit`

- 回滚事务

  `rollback`

对于事务的操作：改成手动提交或开启事务，然后执行DML语句，根据情况进行提交或回滚

### 事务的四大特性

- 原子性（Atomicity）：事务是不可分割的最小操作单元，要么全部成功，要么全部失败
- 一致性（Consistency）：事务完成时，必须使所有的数据都保持一致状态
- 隔离性（Isolation）：数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行
- 持久性（Durability）：事务一旦提交或者回滚，它对数据库中数据的改变就是永久的

### 并发事务

| 问题       | 描述                                                         |
| ---------- | ------------------------------------------------------------ |
| 脏读       | 一个事务读到另外一个事务还没有提交的数据                     |
| 不可重复读 | 一个事务先后读取同一条记录，但两次读取的数据不同（其他事务进行了提交修改），称之为不可重复读 |
| 幻读       | 一个事务按照条件查询时，没有对应的数据行，但是在插入数据时，又发现这行数据已经存在（其他事务提交了） |

### 事务隔离级别 

| 隔离级别                     | 脏读 | 不可重复读 | 幻读 |
| ---------------------------- | ---- | ---------- | ---- |
| read uncommitted             | ✔    | ✔          | ✔    |
| read committed（Oracle默认） | ✘    | ✔          | ✔    |
| repeatable read（mysql默认） | ✘    | ✘          | ✔    |
| Serializable（串行化）       | ✘    | ✘          | ✘    |



事务从上到下隔离级别逐渐变高，事务隔离级别越高，数据越安全，性能越差

```sql
//查看事务隔离级别
select @@transaction_isolation;
//修改事务隔离级别
set [session/global] transaction isolation level {read uncommitted | read committed | repeatable read | serializable}
```



